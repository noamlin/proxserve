function e(e,t,r,o){Object.defineProperty(e,t,{get:r,set:o,enumerable:!0,configurable:!0})}const t=Symbol.for("proxserve_node_data"),r=Symbol.for("proxserve_node_inherited_data"),o={Object:!0,Array:!0};var n,s,l,a,i,u;function p(e){let t=Object.prototype.toString.call(e);return t.substring(8,t.length-1)}(s=n||(n={})).ACTIVE="active",s.STOPPED="stopped",s.BLOCKED="blocked",s.SPLICING="splicing",(a=l||(l={})).ALIVE="alive",a.DELETED="deleted",a.REVOKED="revoked",(u=i||(i={})).create="create",u.update="update",u.delete="delete",u.splice="splice",u.shift="shift",u.unshift="unshift";new WeakSet;function d(e){if("string"!=typeof e||""===e)return[];let t=0,r=!1,o=!1;"."===e[0]?t=1:"["===e[0]&&(t=1,r=!0,o=!0);let n=[],s="";for(;t<e.length;t++){let l=e[t];if(r)if("]"===l)o?n.push(parseInt(s,10)):n.push(s),r=!1,o=!1,s="";else{if(o){let e=l.charCodeAt(0);(e<48||e>57)&&(o=!1)}s+=l}else"["===l&&(r=!0,o=!0),"."===l||"["===l?""!==s&&(n.push(s),s=""):s+=l}return""!==s&&n.push(s),n}function c(e,t){if("symbol"==typeof t)throw new Error("property of type \"symbol\" isn't path'able");const r=p(e);switch(r){case"Object":return`.${t}`;case"Array":return`[${t}]`;default:return console.warn(`Not Implemented (type of '${r}')`),t}}function f(e){const t=p(e);if(o[t]){let r=e;try{r=e.$getOriginalTarget()}catch(e){}switch(t){case"Object":let e=Object.keys(r);for(let t of e)r[t]=f(r[t]);break;case"Array":for(let e=0;e<r.length;e++)r[e]=f(r[e]);break;default:console.warn(`Not Implemented (type of '${t}')`)}return r}return e}function y(e,o,n,s){let l;l=(null==n?void 0:n[t].target)?c(n[t].target,o):c({},o);let a,i=e[o];return i||(i={[r]:Object.create(e[r]),[t]:{parentNode:e,listeners:{shallow:[],deep:[]}}},e[o]=i),delete i[r].status,e[t].isTreePrototype?Object.assign(i[t],{path:"",propertyPath:""}):Object.assign(i[t],{path:e[t].path+l,propertyPath:l}),n?(a={[r]:Object.create(n[r]),[t]:{target:s,dataNode:i}},n[o]=a,i[t].proxyNode=a):a=void 0,{dataNode:i,proxyNode:a}}var h={};function v(e){e[r].status=n.STOPPED}function b(e){e[r].status=n.BLOCKED}function E(e,t,o=!1){o||e===this.dataTree?e[r].status=n.ACTIVE:delete e[r].status}function g(e,r,o,n,s,l){var a;let u=null!==(a=null==l?void 0:l.deep)&&void 0!==a&&a;var p;let c=null!==(p=null==l?void 0:l.id)&&void 0!==p?p:void 0;var f;let h=null!==(f=null==l?void 0:l.once)&&void 0!==f&&f;"change"===o?o=Object.keys(i):Array.isArray(o)||(o=[o]);for(let e of o)if(!i[e]){const t=Object.keys(i);throw new Error(`${e} is not a valid event. valid events are ${t.join(",")}`)}if("function"==typeof n){if("object"==typeof s){const e=s;"boolean"==typeof e.deep&&(u=e.deep),void 0!==e.id&&(c=e.id),"boolean"==typeof e.once&&(h=e.once)}s=n,n=""}else if("function"!=typeof s)throw new Error("invalid arguments were given. listener must be a function");let v=d(n);for(let t of v)e[t]||y(e,t),e=e[t];let b=e[t].listeners.shallow;u&&(b=e[t].listeners.deep);let E={type:o,once:h,func:s};void 0!==c&&(E.id=c),b.push(E)}function x(e,t,r,o,n,s){"object"!=typeof s&&(s={}),s.once=!0,g.call(this,e,t,r,o,n,s)}function P(e,t){for(let r=e.length-1;r>=0;r--){let o=e[r];(void 0!==t&&o.id===t||o.func===t)&&e.splice(r,1)}}function N(e,r,o,n){3===arguments.length&&(n=o,o="");let s=`${e[t].path}${o}`,l=d(o);for(let t of l){if(!e[t])return void console.warn(`can't remove listener from a non-existent path '${s}'`);e=e[t]}P(e[t].listeners.shallow,n),P(e[t].listeners.deep,n)}function m(e,r,o=""){let n=`${e[t].path}${o}`,s=d(o);for(let t of s){if(!e[t])return void console.warn(`can't remove all listeners from a non-existent path '${n}'`);e=e[t]}e[t].listeners.shallow=[],e[t].listeners.deep=[]}function O(e,r){return r[t].target}function w(e,t){return{dataNode:e,proxyNode:t}}e(h,"stop",(function(){return v})),e(h,"block",(function(){return b})),e(h,"activate",(function(){return E})),e(h,"on",(function(){return g})),e(h,"once",(function(){return x})),e(h,"removeListener",(function(){return N})),e(h,"removeAllListeners",(function(){return m})),e(h,"getOriginalTarget",(function(){return O})),e(h,"getProxserveNodes",(function(){return w}));var j={};function I(e,o){if(e[t].proxyNode&&e[t].proxyNode[r].status===l.ALIVE)return e[t].proxyNode[t].proxy;{var n;o||(o=d(e[t].propertyPath)[0]);let s=e[t].parentNode;if(s[t].proxyNode&&s[t].proxyNode[r].status===l.ALIVE)return null===(n=s[t].proxyNode[t].proxy)||void 0===n?void 0:n[o]}}function T(e,o,s,a,u,p){if(s===u||!e[t].proxyNode)return;let d=e[t].proxyNode;if(d[r].status!==l.ALIVE)return;let f,y,h=i.update;void 0===u?h=i.delete:void 0===s&&(h=i.create),e[r].status===n.SPLICING&&(e[t].deferredEvents||(e[t].deferredEvents=[]),f=e[t].deferredEvents),e[o]?(e=e[o],y=""):y=c(d[t].target,o);let v={path:y,value:u,oldValue:s,type:h};f?f.push({dataNode:e,change:v,shouldCapture:a||p}):(A(e,v,o),(a||p)&&D(e,v))}function A(e,o,s){if(e[r].status===n.STOPPED)return;let l=I(e,s);if(""===o.path&&V(e[t].listeners.shallow,l,o),V(e[t].listeners.deep,l,o),!e[t].parentNode[t].isTreePrototype){let r={...o,path:e[t].propertyPath+o.path};A(e[t].parentNode,r)}}function D(e,o){let s=Object.keys(e);for(let l of s){let s="object"==typeof o.value&&null!==o.value?o.value[l]:void 0,a="object"==typeof o.oldValue&&null!==o.oldValue?o.oldValue[l]:void 0;if(s!==a){let o=i.update;void 0===s?o=i.delete:void 0===a&&(o=i.create);let u={path:"",oldValue:a,value:s,type:o},p=e[l];if(p[r].status!==n.STOPPED){let e=I(p,l);V(p[t].listeners.shallow,e,u)}D(p,u)}}}function V(e,t,r){for(let o=e.length-1;o>=0;o--){let n=e[o];n.type.includes(r.type)&&(!0===n.once&&e.splice(o,1),n.func.call(t,r))}}function L(e,r,o,n,s){if(A(e,{path:"",value:s,oldValue:n,type:r,args:o}),e[t].deferredEvents){for(let r of e[t].deferredEvents){if(""===r.change.path){let e=I(r.dataNode);V(r.dataNode[t].listeners.shallow,e,r.change),V(r.dataNode[t].listeners.deep,e,r.change)}r.shouldCapture&&D(r.dataNode,r.change)}delete e[t].deferredEvents}else console.warn(`no side effect events for ${r} were made`)}function C(e,o,s,l,...a){if(e[r].status!==n.ACTIVE)return Array.prototype.splice.call(o[t].proxy,s,l,...a);let u=!e[r].hasOwnProperty("status");e[r].status=n.SPLICING;let p=o[t].target.slice(0),d=Array.prototype.splice.call(o[t].proxy,s,l,...a),c={start:s,deleteCount:l,items:a};return u?delete e[r].status:e[r].status=n.ACTIVE,L(e,i.splice,c,p,o[t].target),d}function $(e,o){if(e[r].status!==n.ACTIVE)return Array.prototype.shift.call(o[t].proxy);let s=!e[r].hasOwnProperty("status");e[r].status=n.SPLICING;let l=o[t].target.slice(0),a=Array.prototype.shift.call(o[t].proxy);return s?delete e[r].status:e[r].status=n.ACTIVE,L(e,i.shift,{},l,o[t].target),a}function k(e,o,...s){if(e[r].status!==n.ACTIVE)return Array.prototype.shift.call(o[t].proxy);let l=!e[r].hasOwnProperty("status");e[r].status=n.SPLICING;let a=o[t].target.slice(0),u=Array.prototype.unshift.call(o[t].proxy,...s),p={items:s};return l?delete e[r].status:e[r].status=n.ACTIVE,L(e,i.unshift,p,a,o[t].target),u}e(j,"splice",(function(){return C})),e(j,"shift",(function(){return $})),e(j,"unshift",(function(){return k}));let S=Object.keys(h);for(let e=S.length-1;e>=0;e--){let t=S[e],r="$"+t;h[r]=h[t],S.push(r)}class K{static make(e,o={}){const{strict:s=!0,emitMethods:a=!0,debug:i={destroyDelay:1e3}}=o;const u=y({[r]:{status:n.ACTIVE},[t]:{isTreePrototype:!0}},"",{[r]:{status:l.ALIVE},[t]:{isTreePrototype:!0}},e),p={strict:s,emitMethods:a,destroyDelay:i.destroyDelay,dataTree:u.dataNode,proxyTree:u.proxyNode};return K.createProxy(p,p.dataTree)}static createProxy(e,s,a){let i,u,d=s[t].proxyNode;if(void 0===a)i=s,u=d;else{const e=y(s,a,d,d[t].target[a]);i=e.dataNode,u=e.proxyNode}let c=u[t].target,v=p(c);if(o[v]){let s=Proxy.revocable(c,{get:(o,n,s)=>e.emitMethods&&Object.prototype.hasOwnProperty.call(j,n)&&n in Object.getPrototypeOf(o)?j[n].bind(e,i,u):S.includes(n)&&void 0===o[n]?h[n].bind(e,i,u):o.propertyIsEnumerable(n)&&"symbol"!=typeof n&&u[n]&&u[n][t].proxy&&u[n][r].status===l.ALIVE?u[n][t].proxy:o[n],set:(s,a,d,c)=>{if(i[r].status===n.BLOCKED)return console.error("object is blocked. can't change value of property:",a),!0;if("symbol"==typeof a)return s[a]=d,!0;if("length"!==a&&!s.propertyIsEnumerable(a)){let e=Object.getOwnPropertyDescriptor(s,a);if("object"==typeof e&&!1===e.enumerable)return s[a]=d,!0}let y=s[a],h=!1;void 0!==u[a]&&void 0!==u[a][t].proxy&&(u[a][r].status=l.DELETED,delete i[a][t].proxyNode,h=!0,e.strict&&setTimeout(K.destroy,e.destroyDelay,u[a][t].proxy)),d=f(d),s[a]=d;let v=!1,b=p(d);return o[b]&&(K.createProxy(e,i,a),v=!0),T(i,a,y,h,d,v),!0},defineProperty:(n,s,a)=>{if("symbol"==typeof s)return Object.defineProperty(n,s,a),!0;let d=n[s],c=!1;void 0!==u[s]&&void 0!==u[s][t].proxy&&(u[s][r].status=l.DELETED,delete i[s][t].proxyNode,c=!0,e.strict&&setTimeout(K.destroy,e.destroyDelay,u[s][t].proxy)),a.value=f(a.value),Object.defineProperty(n,s,a);let y=a.value,h=!1,v=p(a.value);return o[v]&&!0===a.enumerable&&(K.createProxy(e,i,s),h=!0),T(i,s,d,c,y,h),!0},deleteProperty:(o,s)=>{if(!o.propertyIsEnumerable(s)||"symbol"==typeof s)return delete o[s],!0;if(i[r].status===n.BLOCKED)return console.error(`can't delete property '${s}'. object is blocked.`),!0;if(s in o){let n=o[s],a=!1;return void 0!==u[s]&&void 0!==u[s][t].proxy&&(u[s][r].status=l.DELETED,delete i[s][t].proxyNode,a=!0,e.strict&&setTimeout(K.destroy,e.destroyDelay,u[s][t].proxy)),delete o[s],T(i,s,n,a,void 0,!1),!0}return!0}});if(u[t].proxy=s.proxy,u[t].revoke=s.revoke,o[v]){let t=Object.keys(c);for(let r of t){let t=p(c[r]);o[t]&&K.createProxy(e,i,r)}}else console.warn(`Type of "${v}" is not implemented`);return s.proxy}{const e=Object.keys(o);throw new Error(`Must observe an ${e.join("/")}`)}}static destroy(e){let n;try{n=e.$getProxserveNodes().proxyNode}catch(e){return}n[r].status===l.ALIVE&&(n[r].status=l.DELETED);let s=p(e);if(o[s]){let s=Object.keys(e);for(let r of s)try{let s=p(e[r]);o[s]&&K.destroy(n[r][t].proxy)}catch(e){console.error(e)}n[t].revoke(),n[r].status=l.REVOKED}else console.warn(`Type of "${s}" is not implemented`)}static splitPath(e){return d(e)}static evalPath(e,t){return function(e,t){if(""===t)return{object:e,property:"",value:e};let r,o=d(t);for(r=0;r<=o.length-2;r++)if(void 0===(e=e[o[r]]))throw new Error(`Invalid path was given - "${t}"`);return{object:e,property:o[r],value:e[o[r]]}}(e,t)}}export{K as Proxserve};
//# sourceMappingURL=index.min.js.map
