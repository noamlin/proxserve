function e(e,t,r,o){Object.defineProperty(e,t,{get:r,set:o,enumerable:!0,configurable:!0})}const t=Symbol.for("proxserve_node_data"),r=Symbol.for("proxserve_node_inherited_data"),o={Object:!0,Array:!0};var s,n,a,l,i,d;function u(e){let t=Object.prototype.toString.call(e);return t.substring(8,t.length-1)}(n=s||(s={})).ACTIVE="active",n.STOPPED="stopped",n.BLOCKED="blocked",n.SPLICING="splicing",(l=a||(a={})).ALIVE="alive",l.DELETED="deleted",l.REVOKED="revoked",(d=i||(i={})).create="create",d.update="update",d.delete="delete",d.splice="splice",d.shift="shift",d.unshift="unshift";new WeakSet;function p(e){if("string"!=typeof e||""===e)return[];let t=0,r=!1,o=!1;"."===e[0]?t=1:"["===e[0]&&(t=1,r=!0,o=!0);let s=[],n="";for(;t<e.length;t++){let a=e[t];if(r)if("]"===a)o?s.push(parseInt(n,10)):s.push(n),r=!1,o=!1,n="";else{if(o){let e=a.charCodeAt(0);(e<48||e>57)&&(o=!1)}n+=a}else"["===a&&(r=!0,o=!0),"."===a||"["===a?""!==n&&(s.push(n),n=""):n+=a}return""!==n&&s.push(n),s}function c(e,t){if("symbol"==typeof t)throw new Error("property of type \"symbol\" isn't path'able");const r=u(e);switch(r){case"Object":return`.${t}`;case"Array":return`[${t}]`;default:return console.warn(`Not Implemented (type of '${r}')`),t}}function y(e){const t=u(e);if(o[t]){let r=e;try{r=e.$getOriginalTarget()}catch(e){}switch(t){case"Object":let e=Object.keys(r);for(let t of e)r[t]=y(r[t]);break;case"Array":for(let e=0;e<r.length;e++)r[e]=y(r[e]);break;default:console.warn(`Not Implemented (type of '${t}')`)}return r}return e}function f(e,o,s,n){let a;a=(null==s?void 0:s[t].target)?c(s[t].target,o):c({},o);let l,i=e[o];return i||(i={[r]:Object.create(e[r]),[t]:{parentNode:e,listeners:{shallow:[],deep:[]}}},e[o]=i),delete i[r].status,e[t].isTreePrototype?Object.assign(i[t],{path:"",propertyPath:""}):Object.assign(i[t],{path:e[t].path+a,propertyPath:a}),s?(l={[r]:Object.create(s[r]),[t]:{target:n,dataNode:i}},s[o]=l,i[t].proxyNode=l):l=void 0,{dataNode:i,proxyNode:l}}var h={};e(h,"stop",(function(){return v})),e(h,"block",(function(){return N})),e(h,"activate",(function(){return b})),e(h,"on",(function(){return x})),e(h,"once",(function(){return E})),e(h,"removeListener",(function(){return P})),e(h,"removeAllListeners",(function(){return m})),e(h,"getOriginalTarget",(function(){return O})),e(h,"getProxserveNodes",(function(){return I}));const v=function(){this.dataNode[r].status=s.STOPPED},N=function(){this.dataNode[r].status=s.BLOCKED},b=function(e=!1){e||this.dataNode===this.metadata.dataTree?this.dataNode[r].status=s.ACTIVE:delete this.dataNode[r].status},x=function(e){const{path:r="",listener:o,options:s={}}=e;let{events:n}=e;var a,l;s.deep=null!==(a=s.deep)&&void 0!==a&&a,s.once=null!==(l=s.once)&&void 0!==l&&l,"change"===n?n=Object.keys(i):Array.isArray(n)||(n=[n]);for(let e of n)if(!i[e]){const t=Object.keys(i);throw new Error(`${e} is not a valid event. valid events are ${t.join(",")}`)}let d=this.dataNode,u=p(r);for(let e of u)d[e]||f(d,e),d=d[e];let c=d[t].listeners.shallow;s.deep&&(c=d[t].listeners.deep);let y={type:n,once:s.once,func:o};void 0!==s.id&&(y.id=s.id),c.push(y)},E=function(e){const{events:t,path:r,listener:o,options:s={}}=e;s.once=!0,x.call(this,{events:t,path:r,listener:o,options:s})};function g(e,t){for(let r=e.length-1;r>=0;r--){let o=e[r];(void 0!==t&&o.id===t||o.func===t)&&e.splice(r,1)}}const P=function(e){const{id:r,path:o=""}=e,s=`${this.dataNode[t].path}${o}`;let n=this.dataNode;const a=p(o);for(let e of a){if(!n[e])return void console.warn(`can't remove listener from a non-existent path '${s}'`);n=n[e]}g(n[t].listeners.shallow,r),g(n[t].listeners.deep,r)},m=function(e=""){const r=`${this.dataNode[t].path}${e}`,o=p(e);let s=this.dataNode;for(let e of o){if(!s[e])return void console.warn(`can't remove all listeners from a non-existent path '${r}'`);s=s[e]}s[t].listeners.shallow=[],s[t].listeners.deep=[]},O=function(){return this.proxyNode[t].target},I=function(){return{dataNode:this.dataNode,proxyNode:this.proxyNode}};var T={};function w(e,o){if(e[t].proxyNode&&e[t].proxyNode[r].status===a.ALIVE)return e[t].proxyNode[t].proxy;{var s;o||(o=p(e[t].propertyPath)[0]);let n=e[t].parentNode;if(n[t].proxyNode&&n[t].proxyNode[r].status===a.ALIVE)return null===(s=n[t].proxyNode[t].proxy)||void 0===s?void 0:s[o]}}function j(e,o,n,l,d,u){if(n===d||!e[t].proxyNode)return;let p=e[t].proxyNode;if(p[r].status!==a.ALIVE)return;let y,f,h=i.update;void 0===d?h=i.delete:void 0===n&&(h=i.create),e[r].status===s.SPLICING&&(e[t].deferredEvents||(e[t].deferredEvents=[]),y=e[t].deferredEvents),e[o]?(e=e[o],f=""):f=c(p[t].target,o);let v={path:f,value:d,oldValue:n,type:h};y?y.push({dataNode:e,change:v,shouldCapture:l||u}):(A(e,v,o),(l||u)&&D(e,v))}function A(e,o,n){if(e[r].status===s.STOPPED)return;let a=w(e,n);if(""===o.path&&V(e[t].listeners.shallow,a,o),V(e[t].listeners.deep,a,o),!e[t].parentNode[t].isTreePrototype){let r={...o,path:e[t].propertyPath+o.path};A(e[t].parentNode,r)}}function D(e,o){let n=Object.keys(e);for(let a of n){let n="object"==typeof o.value&&null!==o.value?o.value[a]:void 0,l="object"==typeof o.oldValue&&null!==o.oldValue?o.oldValue[a]:void 0;if(n!==l){let o=i.update;void 0===n?o=i.delete:void 0===l&&(o=i.create);let d={path:"",oldValue:l,value:n,type:o},u=e[a];if(u[r].status!==s.STOPPED){let e=w(u,a);V(u[t].listeners.shallow,e,d)}D(u,d)}}}function V(e,t,r){for(let o=e.length-1;o>=0;o--){let s=e[o];s.type.includes(r.type)&&(!0===s.once&&e.splice(o,1),s.func.call(t,r))}}function L(e,r,o,s,n){if(A(e,{path:"",value:n,oldValue:s,type:r,args:o}),e[t].deferredEvents){for(let r of e[t].deferredEvents){if(""===r.change.path){let e=w(r.dataNode);V(r.dataNode[t].listeners.shallow,e,r.change),V(r.dataNode[t].listeners.deep,e,r.change)}r.shouldCapture&&D(r.dataNode,r.change)}delete e[t].deferredEvents}else console.warn(`no side effect events for ${r} were made`)}function C(e,o,n,a,...l){if(e[r].status!==s.ACTIVE)return Array.prototype.splice.call(o[t].proxy,n,a,...l);let d=!e[r].hasOwnProperty("status");e[r].status=s.SPLICING;let u=o[t].target.slice(0),p=Array.prototype.splice.call(o[t].proxy,n,a,...l),c={start:n,deleteCount:a,items:l};return d?delete e[r].status:e[r].status=s.ACTIVE,L(e,i.splice,c,u,o[t].target),p}function $(e,o){if(e[r].status!==s.ACTIVE)return Array.prototype.shift.call(o[t].proxy);let n=!e[r].hasOwnProperty("status");e[r].status=s.SPLICING;let a=o[t].target.slice(0),l=Array.prototype.shift.call(o[t].proxy);return n?delete e[r].status:e[r].status=s.ACTIVE,L(e,i.shift,{},a,o[t].target),l}function k(e,o,...n){if(e[r].status!==s.ACTIVE)return Array.prototype.shift.call(o[t].proxy);let a=!e[r].hasOwnProperty("status");e[r].status=s.SPLICING;let l=o[t].target.slice(0),d=Array.prototype.unshift.call(o[t].proxy,...n),u={items:n};return a?delete e[r].status:e[r].status=s.ACTIVE,L(e,i.unshift,u,l,o[t].target),d}e(T,"splice",(function(){return C})),e(T,"shift",(function(){return $})),e(T,"unshift",(function(){return k}));let S=Object.keys(h);for(let e=S.length-1;e>=0;e--){let t=S[e],r="$"+t;h[r]=h[t],S.push(r)}class K{static make(e,o={}){const{strict:n=!0,emitMethods:l=!0,debug:i={destroyDelay:1e3}}=o;const d=f({[r]:{status:s.ACTIVE},[t]:{isTreePrototype:!0}},"",{[r]:{status:a.ALIVE},[t]:{isTreePrototype:!0}},e),u={strict:n,emitMethods:l,destroyDelay:i.destroyDelay,dataTree:d.dataNode,proxyTree:d.proxyNode};return K.createProxy(u,u.dataTree)}static createProxy(e,n,l){let i,d,p=n[t].proxyNode;if(void 0===l)i=n,d=p;else{const e=f(n,l,p,p[t].target[l]);i=e.dataNode,d=e.proxyNode}let c=d[t].target,v=u(c);if(o[v]){let n=Proxy.revocable(c,{get:(o,s,n)=>e.emitMethods&&Object.prototype.hasOwnProperty.call(T,s)&&s in Object.getPrototypeOf(o)?T[s].bind({metadata:e,dataNode:i,proxyNode:d}):S.includes(s)&&void 0===o[s]?h[s].bind({metadata:e,dataNode:i,proxyNode:d}):o.propertyIsEnumerable(s)&&"symbol"!=typeof s&&d[s]&&d[s][t].proxy&&d[s][r].status===a.ALIVE?d[s][t].proxy:o[s],set:(n,l,p,c)=>{if(i[r].status===s.BLOCKED)return console.error("object is blocked. can't change value of property:",l),!0;if("symbol"==typeof l)return n[l]=p,!0;if("length"!==l&&!n.propertyIsEnumerable(l)){let e=Object.getOwnPropertyDescriptor(n,l);if("object"==typeof e&&!1===e.enumerable)return n[l]=p,!0}let f=n[l],h=!1;void 0!==d[l]&&void 0!==d[l][t].proxy&&(d[l][r].status=a.DELETED,delete i[l][t].proxyNode,h=!0,e.strict&&setTimeout(K.destroy,e.destroyDelay,d[l][t].proxy)),p=y(p),n[l]=p;let v=!1,N=u(p);return o[N]&&(K.createProxy(e,i,l),v=!0),j(i,l,f,h,p,v),!0},defineProperty:(s,n,l)=>{if("symbol"==typeof n)return Object.defineProperty(s,n,l),!0;let p=s[n],c=!1;void 0!==d[n]&&void 0!==d[n][t].proxy&&(d[n][r].status=a.DELETED,delete i[n][t].proxyNode,c=!0,e.strict&&setTimeout(K.destroy,e.destroyDelay,d[n][t].proxy)),l.value=y(l.value),Object.defineProperty(s,n,l);let f=l.value,h=!1,v=u(l.value);return o[v]&&!0===l.enumerable&&(K.createProxy(e,i,n),h=!0),j(i,n,p,c,f,h),!0},deleteProperty:(o,n)=>{if(!o.propertyIsEnumerable(n)||"symbol"==typeof n)return delete o[n],!0;if(i[r].status===s.BLOCKED)return console.error(`can't delete property '${n}'. object is blocked.`),!0;if(n in o){let s=o[n],l=!1;return void 0!==d[n]&&void 0!==d[n][t].proxy&&(d[n][r].status=a.DELETED,delete i[n][t].proxyNode,l=!0,e.strict&&setTimeout(K.destroy,e.destroyDelay,d[n][t].proxy)),delete o[n],j(i,n,s,l,void 0,!1),!0}return!0}});if(d[t].proxy=n.proxy,d[t].revoke=n.revoke,o[v]){let t=Object.keys(c);for(let r of t){let t=u(c[r]);o[t]&&K.createProxy(e,i,r)}}else console.warn(`Type of "${v}" is not implemented`);return n.proxy}{const e=Object.keys(o);throw new Error(`Must observe an ${e.join("/")}`)}}static destroy(e){let s;try{s=e.$getProxserveNodes().proxyNode}catch(e){return}s[r].status===a.ALIVE&&(s[r].status=a.DELETED);let n=u(e);if(o[n]){let n=Object.keys(e);for(let r of n)try{let n=u(e[r]);o[n]&&K.destroy(s[r][t].proxy)}catch(e){console.error(e)}s[t].revoke(),s[r].status=a.REVOKED}else console.warn(`Type of "${n}" is not implemented`)}static splitPath(e){return p(e)}static evalPath(e,t){return function(e,t){if(""===t)return{object:e,property:"",value:e};let r,o=p(t);for(r=0;r<=o.length-2;r++)if(void 0===(e=e[o[r]]))throw new Error(`Invalid path was given - "${t}"`);return{object:e,property:o[r],value:e[o[r]]}}(e,t)}}export{K as Proxserve};
//# sourceMappingURL=index.min.js.map
