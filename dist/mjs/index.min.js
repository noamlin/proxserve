function e(e,t,r,o){Object.defineProperty(e,t,{get:r,set:o,enumerable:!0,configurable:!0})}const t=Symbol.for("proxserve_node_data"),r=Symbol.for("proxserve_node_inherited_data"),o={Object:!0,Array:!0};var s,n,a,l,i,u;function c(e){let t=Object.prototype.toString.call(e);return t.substring(8,t.length-1)}(n=s||(s={})).ACTIVE="active",n.STOPPED="stopped",n.BLOCKED="blocked",n.SPLICING="splicing",(l=a||(a={})).ALIVE="alive",l.DELETED="deleted",l.REVOKED="revoked",(u=i||(i={})).create="create",u.update="update",u.delete="delete",u.splice="splice",u.shift="shift",u.unshift="unshift";new WeakSet;function p(e){if("string"!=typeof e||""===e)return[];let t=0,r=!1,o=!1;"."===e[0]?t=1:"["===e[0]&&(t=1,r=!0,o=!0);let s=[],n="";for(;t<e.length;t++){let a=e[t];if(r)if("]"===a)o?s.push(parseInt(n,10)):s.push(n),r=!1,o=!1,n="";else{if(o){let e=a.charCodeAt(0);(e<48||e>57)&&(o=!1)}n+=a}else"["===a&&(r=!0,o=!0),"."===a||"["===a?""!==n&&(s.push(n),n=""):n+=a}return""!==n&&s.push(n),s}function d(e,t){if("symbol"==typeof t)throw new Error("property of type \"symbol\" isn't path'able");const r=c(e);switch(r){case"Object":return`.${t}`;case"Array":return`[${t}]`;default:return console.warn(`Not Implemented (type of '${r}')`),t}}function f(e){const t=c(e);if(o[t]){let r=e;try{r=e.$getOriginalTarget()}catch(e){}switch(t){case"Object":let e=Object.keys(r);for(let t of e)r[t]=f(r[t]);break;case"Array":for(let e=0;e<r.length;e++)r[e]=f(r[e]);break;default:console.warn(`Not Implemented (type of '${t}')`)}return r}return e}function y(e,o,s,n){let a;a=(null==o?void 0:o[t].target)?d(o[t].target,s):d({},s);let l,i=e[s];return i||(i={[r]:Object.create(e[r]),[t]:{parentNode:e,listeners:{shallow:[],deep:[]}}},e[s]=i),delete i[r].status,e[t].isTreePrototype?Object.assign(i[t],{path:"",propertyPath:""}):Object.assign(i[t],{path:e[t].path+a,propertyPath:a}),o&&(l={[r]:Object.create(o[r]),[t]:{target:n,dataNode:i}},o[s]=l,i[t].proxyNode=l),{dataNode:i,proxyNode:l}}var h={};function v(e){e[r].status=s.STOPPED}function b(e){e[r].status=s.BLOCKED}function E(e,t,o=!1){o||e===this.dataTree?e[r].status=s.ACTIVE:delete e[r].status}function g(e,r,o,s,n,a){let{deep:l=!1,id:u,once:c=!1}=a;"change"===o?o=Object.keys(i):Array.isArray(o)||(o=[o]);for(let e of o)if(!i[e]){const t=Object.keys(i);throw new Error(`${e} is not a valid event. valid events are ${t.join(",")}`)}if("function"==typeof s){if("object"==typeof n){const e=n;"boolean"==typeof e.deep&&(l=e.deep),void 0!==e.id&&(u=e.id),"boolean"==typeof e.once&&(c=e.once)}n=s,s=""}else if("function"!=typeof n)throw new Error("invalid arguments were given. listener must be a function");let d=p(s);for(let t of d)e[t]||y(e,void 0,t,void 0),e=e[t];let f=e[t].listeners.shallow;l&&(f=e[t].listeners.deep);let h={type:o,once:c,func:n};void 0!==u&&(h.id=u),f.push(h)}function x(e,t,r,o,s,n){"object"!=typeof n&&(n={}),n.once=!0,g.call(this,e,t,r,o,s,n)}function P(e,t){for(let r=e.length-1;r>=0;r--){let o=e[r];(void 0!==t&&o.id===t||o.func===t)&&e.splice(r,1)}}function N(e,r,o,s){3===arguments.length&&(s=o,o="");let n=`${e[t].path}${o}`,a=p(o);for(let t of a){if(!e[t])return void console.warn(`can't remove listener from a non-existent path '${n}'`);e=e[t]}P(e[t].listeners.shallow,s),P(e[t].listeners.deep,s)}function O(e,r,o=""){let s=`${e[t].path}${o}`,n=p(o);for(let t of n){if(!e[t])return void console.warn(`can't remove all listeners from a non-existent path '${s}'`);e=e[t]}e[t].listeners.shallow=[],e[t].listeners.deep=[]}function m(e,r){return r[t].target}function w(e,t){return{dataNode:e,proxyNode:t}}function I(){return this}e(h,"stop",(function(){return v})),e(h,"block",(function(){return b})),e(h,"activate",(function(){return E})),e(h,"on",(function(){return g})),e(h,"once",(function(){return x})),e(h,"removeListener",(function(){return N})),e(h,"removeAllListeners",(function(){return O})),e(h,"getOriginalTarget",(function(){return m})),e(h,"getProxserveNodes",(function(){return w})),e(h,"getProxserveInstance",(function(){return I}));var j={};function T(e,o){if(e[t].proxyNode&&e[t].proxyNode[r].status===a.ALIVE)return e[t].proxyNode[t].proxy;{o||(o=p(e[t].propertyPath)[0]);let s=e[t].parentNode;if(s[t].proxyNode&&s[t].proxyNode[r].status===a.ALIVE)return s[t].proxyNode[t].proxy[o]}}function A(e,o,n,l,u,c){if(n===u||!e[t].proxyNode)return;let p=e[t].proxyNode;if(p[r].status!==a.ALIVE)return;let f,y,h=i.update;void 0===u?h=i.delete:void 0===n&&(h=i.create),e[r].status===s.SPLICING&&(e[t].deferredEvents||(e[t].deferredEvents=[]),f=e[t].deferredEvents),e[o]?(e=e[o],y=""):y=d(p[t].target,o);let v={path:y,value:u,oldValue:n,type:h};f?f.push({dataNode:e,change:v,shouldCapture:l||c}):(D(e,v,o),(l||c)&&V(e,v))}function D(e,o,n){if(e[r].status===s.STOPPED)return;let a=T(e,n);if(""===o.path&&L(e[t].listeners.shallow,a,o),L(e[t].listeners.deep,a,o),!e[t].parentNode[t].isTreePrototype){let r={...o,path:e[t].propertyPath+o.path};D(e[t].parentNode,r)}}function V(e,o){let n=Object.keys(e);for(let a of n){let n="object"==typeof o.value&&null!==o.value?o.value[a]:void 0,l="object"==typeof o.oldValue&&null!==o.oldValue?o.oldValue[a]:void 0;if(n!==l){let o=i.update;void 0===n?o=i.delete:void 0===l&&(o=i.create);let u={path:"",oldValue:l,value:n,type:o},c=e[a];if(c[r].status!==s.STOPPED){let e=T(c,a);L(c[t].listeners.shallow,e,u)}V(c,u)}}}function L(e,t,r){for(let o=e.length-1;o>=0;o--){let s=e[o];s.type.includes(r.type)&&(!0===s.once&&e.splice(o,1),s.func.call(t,r))}}function C(e,r,o,s,n){if(D(e,{path:"",value:n,oldValue:s,type:r,args:o}),e[t].deferredEvents){for(let r of e[t].deferredEvents){if(""===r.change.path){let e=T(r.dataNode);L(r.dataNode[t].listeners.shallow,e,r.change),L(r.dataNode[t].listeners.deep,e,r.change)}r.shouldCapture&&V(r.dataNode,r.change)}delete e[t].deferredEvents}else console.warn(`no side effect events for ${r} were made`)}function $(e,o,n,a,...l){if(e[r].status!==s.ACTIVE)return Array.prototype.splice.call(o[t].proxy,n,a,...l);let u=!e[r].hasOwnProperty("status");e[r].status=s.SPLICING;let c=o[t].target.slice(0),p=Array.prototype.splice.call(o[t].proxy,n,a,...l),d={start:n,deleteCount:a,items:l};return u?delete e[r].status:e[r].status=s.ACTIVE,C(e,i.splice,d,c,o[t].target),p}function k(e,o){if(e[r].status!==s.ACTIVE)return Array.prototype.shift.call(o[t].proxy);let n=!e[r].hasOwnProperty("status");e[r].status=s.SPLICING;let a=o[t].target.slice(0),l=Array.prototype.shift.call(o[t].proxy);return n?delete e[r].status:e[r].status=s.ACTIVE,C(e,i.shift,{},a,o[t].target),l}function S(e,o,...n){if(e[r].status!==s.ACTIVE)return Array.prototype.shift.call(o[t].proxy);let a=!e[r].hasOwnProperty("status");e[r].status=s.SPLICING;let l=o[t].target.slice(0),u=Array.prototype.unshift.call(o[t].proxy,...n),c={items:n};return a?delete e[r].status:e[r].status=s.ACTIVE,C(e,i.unshift,c,l,o[t].target),u}e(j,"splice",(function(){return $})),e(j,"shift",(function(){return k})),e(j,"unshift",(function(){return S}));let K=Object.keys(h);for(let e=K.length-1;e>=0;e--){let t=K[e],r="$"+t;h[r]=h[t],K.push(r)}class G{createProxy(e,n){let l,i,u=e[t].proxyNode;if(void 0===n)l=e,i=u;else{const r=y(e,u,n,u[t].target[n]);l=r.dataNode,i=r.proxyNode}let p=i[t].target,d=c(p);if(o[d]){let e=Proxy.revocable(p,{get:(e,o,s)=>this.emitMethods&&Object.prototype.hasOwnProperty.call(j,o)&&o in Object.getPrototypeOf(e)?j[o].bind(this,l,i):K.includes(o)&&void 0===e[o]?h[o].bind(this,l,i):e.propertyIsEnumerable(o)&&"symbol"!=typeof o&&i[o]&&i[o][t].proxy&&i[o][r].status===a.ALIVE?i[o][t].proxy:e[o],set:(e,n,u,p)=>{if(l[r].status===s.BLOCKED)return console.error("object is blocked. can't change value of property:",n),!0;if("symbol"==typeof n)return e[n]=u,!0;if("length"!==n&&!e.propertyIsEnumerable(n)){let t=Object.getOwnPropertyDescriptor(e,n);if("object"==typeof t&&!1===t.enumerable)return e[n]=u,!0}let d=e[n],y=!1;void 0!==i[n]&&void 0!==i[n][t].proxy&&(i[n][r].status=a.DELETED,delete l[n][t].proxyNode,y=!0,this.strict&&setTimeout(G.destroy,this.destroyDelay,i[n][t].proxy)),u=f(u),e[n]=u;let h=!1,v=c(u);return o[v]&&(this.createProxy(l,n),h=!0),A(l,n,d,y,u,h),!0},defineProperty:(e,s,n)=>{if("symbol"==typeof s)return Object.defineProperty(e,s,n),!0;let u=e[s],p=!1;void 0!==i[s]&&void 0!==i[s][t].proxy&&(i[s][r].status=a.DELETED,delete l[s][t].proxyNode,p=!0,this.strict&&setTimeout(G.destroy,this.destroyDelay,i[s][t].proxy)),n.value=f(n.value),Object.defineProperty(e,s,n);let d=n.value,y=!1,h=c(n.value);return o[h]&&!0===n.enumerable&&(this.createProxy(l,s),y=!0),A(l,s,u,p,d,y),!0},deleteProperty:(e,o)=>{if(!e.propertyIsEnumerable(o)||"symbol"==typeof o)return delete e[o],!0;if(l[r].status===s.BLOCKED)return console.error(`can't delete property '${o}'. object is blocked.`),!0;if(o in e){let s=e[o],n=!1;return void 0!==i[o]&&void 0!==i[o][t].proxy&&(i[o][r].status=a.DELETED,delete l[o][t].proxyNode,n=!0,this.strict&&setTimeout(G.destroy,this.destroyDelay,i[o][t].proxy)),delete e[o],A(l,o,s,n,void 0,!1),!0}return!0}});if(i[t].proxy=e.proxy,i[t].revoke=e.revoke,o[d]){let e=Object.keys(p);for(let t of e){let e=c(p[t]);o[e]&&this.createProxy(l,t)}}else console.warn(`Type of "${d}" is not implemented`);return e.proxy}{const e=Object.keys(o);throw new Error(`Must observe an ${e.join("/")}`)}}static destroy(e){let s;try{[,s]=e.$getProxserveNodes()}catch(e){return}s[r].status===a.ALIVE&&(s[r].status=a.DELETED);let n=c(e);if(o[n]){let n=Object.keys(e);for(let r of n)try{let n=c(e[r]);o[n]&&G.destroy(s[r][t].proxy)}catch(e){console.error(e)}s[t].revoke(),s[r].status=a.REVOKED}else console.warn(`Type of "${n}" is not implemented`)}static splitPath(e){return p(e)}static evalPath(e,t){return function(e,t){if(""===t)return{object:e,property:void 0,value:e};let r,o=p(t);for(r=0;r<=o.length-2;r++)if(void 0===(e=e[o[r]]))throw new Error(`Invalid path was given - "${t}"`);return{object:e,property:o[r],value:e[o[r]]}}(e,t)}constructor(e,o){this.strict=o.strict,this.emitMethods=o.emitMethods,this.destroyDelay=1e3,o.debug&&o.debug.destroyDelay&&(this.destroyDelay=o.debug.destroyDelay);const n=y({[r]:{status:s.ACTIVE},[t]:{isTreePrototype:!0}},{[r]:{status:a.ALIVE},[t]:{isTreePrototype:!0}},"",e);return this.dataTree=n.dataNode,this.proxyTree=n.proxyNode,this.createProxy(this.dataTree)}}export{G as Proxserve};
//# sourceMappingURL=index.min.js.map
