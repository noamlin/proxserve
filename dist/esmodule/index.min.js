function e(e,t,o,r){Object.defineProperty(e,t,{get:o,set:r,enumerable:!0,configurable:!0})}const t=Symbol.for("proxserve_node_data"),o=Symbol.for("proxserve_node_inherited_data"),r={Object:!0,Array:!0};let a;var s;let n;var i;let l;var d;function c(e){let t=Object.prototype.toString.call(e);return t.substring(8,t.length-1)}(s=a||(a={})).active="active",s.stopped="stopped",s.blocked="blocked",s.splicing="splicing",(i=n||(n={})).alive="alive",i.deleted="deleted",i.revoked="revoked",(d=l||(l={})).create="create",d.update="update",d.delete="delete",d.splice="splice",d.shift="shift",d.unshift="unshift";new WeakSet;function p(e){if("string"!=typeof e||""===e)return[];let t=0,o=!1,r=!1;"."===e[0]?t=1:"["===e[0]&&(t=1,o=!0,r=!0);let a=[],s="";for(;t<e.length;t++){let n=e[t];if(o)if("]"===n)r?a.push(parseInt(s,10)):a.push(s),o=!1,r=!1,s="";else{if(r){let e=n.charCodeAt(0);(e<48||e>57)&&(r=!1)}s+=n}else"["===n&&(o=!0,r=!0),"."===n||"["===n?""!==s&&(a.push(s),s=""):s+=n}return""!==s&&a.push(s),a}function u(e,t){if(""===t)return{object:e,property:"",value:e};let o,r=p(t);for(o=0;o<=r.length-2;o++)if(void 0===(e=e[r[o]]))throw new Error(`Invalid path was given - "${t}"`);return{object:e,property:r[o],value:e[r[o]]}}var f={};e(f,"stop",(function(){return y})),e(f,"block",(function(){return h})),e(f,"activate",(function(){return v})),e(f,"on",(function(){return N})),e(f,"once",(function(){return x})),e(f,"removeListener",(function(){return b})),e(f,"removeAllListeners",(function(){return m})),e(f,"getOriginalTarget",(function(){return w})),e(f,"getProxserveName",(function(){return O})),e(f,"whoami",(function(){return j})),e(f,"getProxserveNodes",(function(){return P}));const y=function(){this.dataNode[o].status=a.stopped},h=function(){this.dataNode[o].status=a.blocked},v=function(e=!1){e||this.dataNode===this.metadata.dataTree?this.dataNode[o].status=a.active:delete this.dataNode[o].status},N=function(e){const{path:o="",listener:r,id:a,deep:s=!1,once:n=!1}=e;let{event:i}=e;"change"===i?i=Object.keys(l):Array.isArray(i)||(i=[i]);for(let e of i)if(!l[e]){const t=Object.keys(l);throw new Error(`${e} is not a valid event. valid events are ${t.join(",")}`)}let d=this.dataNode,c=p(o);for(let e of c)d[e]||E(d,e),d=d[e];let u=d[t].listeners.shallow;s&&(u=d[t].listeners.deep);let f={type:i,once:n,func:r};void 0!==a&&(f.id=a),u.push(f)},x=function(e){e.once=!0,N.call(this,e)};function g(e,t){for(let o=e.length-1;o>=0;o--){let r=e[o];(void 0!==t&&r.id===t||r.func===t)&&e.splice(o,1)}}const b=function(e){const{id:o,path:r=""}=e,a=`${this.dataNode[t].path}${r}`;let s=this.dataNode;const n=p(r);for(let e of n){if(!s[e])return void console.warn(`can't remove listener from a non-existent path '${a}'`);s=s[e]}g(s[t].listeners.shallow,o),g(s[t].listeners.deep,o)},m=function(e=""){const o=`${this.dataNode[t].path}${e}`,r=p(e);let a=this.dataNode;for(let e of r){if(!a[e])return void console.warn(`can't remove all listeners from a non-existent path '${o}'`);a=a[e]}a[t].listeners.shallow=[],a[t].listeners.deep=[]},w=function(){return this.proxyNode[t].target},O=function(){return this.dataNode[o].name},j=function(){return this.dataNode[o].name+this.dataNode[t].path},P=function(){return{dataNode:this.dataNode,proxyNode:this.proxyNode}};function k(e,t){if("symbol"==typeof t)throw new Error("property of type \"symbol\" isn't path'able");const o=c(e);switch(o){case"Object":return`.${t}`;case"Array":return`[${t}]`;default:return console.warn(`Not Implemented (type of '${o}')`),t}}function $(e){const t=c(e);if(r[t]){let o=e;try{o=e.$getOriginalTarget()}catch(e){}switch(t){case"Object":let e=Object.keys(o);for(let t of e)o[t]=$(o[t]);break;case"Array":for(let e=0;e<o.length;e++)o[e]=$(o[e]);break;default:console.warn(`Not Implemented (type of '${t}')`)}return o}return e}function E(e,r,a,s){let n;n=a?.[t].target?k(a[t].target,r):k({},r);let i,l=e[r];return l||(l={[o]:Object.create(e[o]),[t]:{parentNode:e,listeners:{shallow:[],deep:[]}}},e[r]=l),delete l[o].status,e[t].isTreePrototype?Object.assign(l[t],{path:"",propertyPath:""}):Object.assign(l[t],{path:e[t].path+n,propertyPath:n}),a?(i={[o]:Object.create(a[o]),[t]:{target:s,dataNode:l}},a[r]=i,l[t].proxyNode=i):i=void 0,{dataNode:l,proxyNode:i}}let T=!1;function A(e,t,o){if("normal"!==o&&"verbose"!==o)return;const r=(new Error).stack;if(!r)return void(T||(console.error("Can't log stack trace of proxserve. browser/runtime doesn't support Error.stack"),T=!0));const a=r.split("\n").map((e=>e.trim()));0===a[0].toLowerCase().indexOf("error")&&a.shift(),a.shift(),a[0]="Stack Trace:";const s=j.call({dataNode:e})+t.path;let n=t.type;t.type===l.shift||t.type===l.unshift?n+="ed":n+="d",console.log("%c                                                                ","border-bottom: 1px solid #008;"),console.log(`%c${s} %chas been ${n}:`,"font-weight: bold; color: #008;","color: #000;"),"verbose"===o&&("splice"!==t.type&&"unshift"!==t.type||(console.log(`%cArguments of ${t.type}:`,"color: #555; font-style: italic;"),console.log(t.args)),console.log("%cOld value was:","color: #555; font-style: italic;"),console.log(t.oldValue),console.log("%cNew value is:","color: #555; font-style: italic;"),console.log(t.value)),console.log(`%c${a.join("\n")}`,"color: #999;"),console.log("%c                                                                ","border-top: 1px solid #008;")}var _={};function I(e,r){if(e[t].proxyNode&&e[t].proxyNode[o].status===n.alive)return e[t].proxyNode[t].proxy;{r||(r=p(e[t].propertyPath)[0]);let a=e[t].parentNode;if(a[t].proxyNode&&a[t].proxyNode[o].status===n.alive)return a[t].proxyNode[t].proxy?.[r]}}function V(e,r,s,i,d,c,p){if(s===d||!e[t].proxyNode)return;let u=e[t].proxyNode;if(u[o].status!==n.alive)return;let f,y,h=l.update;void 0===d?h=l.delete:void 0===s&&(h=l.create),e[o].status===a.splicing&&(e[t].deferredEvents||(e[t].deferredEvents=[]),f=e[t].deferredEvents),e[r]?(e=e[r],y=""):y=k(u[t].target,r);let v={path:y,value:d,oldValue:s,type:h};f?f.push({dataNode:e,change:v,shouldCapture:i||c}):(A(e,v,p),C(e,v,r),(i||c)&&D(e,v))}function C(e,r,s){if(e[o].status===a.stopped)return;let n=I(e,s);if(""===r.path&&S(e[t].listeners.shallow,n,r),S(e[t].listeners.deep,n,r),!e[t].parentNode[t].isTreePrototype){let o={...r,path:e[t].propertyPath+r.path};C(e[t].parentNode,o)}}function D(e,r){let s=Object.keys(e);for(let n of s){let s="object"==typeof r.value&&null!==r.value?r.value[n]:void 0,i="object"==typeof r.oldValue&&null!==r.oldValue?r.oldValue[n]:void 0;if(s!==i){let r=l.update;void 0===s?r=l.delete:void 0===i&&(r=l.create);let d={path:"",oldValue:i,value:s,type:r},c=e[n];if(c[o].status!==a.stopped){let e=I(c,n);S(c[t].listeners.shallow,e,d)}D(c,d)}}}function S(e,t,o){for(let r=e.length-1;r>=0;r--){let a=e[r];a.type.includes(o.type)&&(!0===a.once&&e.splice(r,1),a.func.call(t,o))}}function L(e,o,r,a,s,n){let i={path:"",value:s,oldValue:a,type:o,args:r};if(A(e,i,n),C(e,i),e[t].deferredEvents){for(let o of e[t].deferredEvents){if(""===o.change.path){let e=I(o.dataNode);S(o.dataNode[t].listeners.shallow,e,o.change),S(o.dataNode[t].listeners.deep,e,o.change)}o.shouldCapture&&D(o.dataNode,o.change)}delete e[t].deferredEvents}else console.warn(`no side effect events for ${o} were made`)}e(_,"splice",(function(){return R})),e(_,"shift",(function(){return M})),e(_,"unshift",(function(){return W}));const R=function(e,r,...s){if(this.dataNode[o].status!==a.active)return Array.prototype.splice.call(this.proxyNode[t].proxy,e,r,...s);let n=!this.dataNode[o].hasOwnProperty("status");this.dataNode[o].status=a.splicing;let i=this.proxyNode[t].target.slice(0),d=Array.prototype.splice.call(this.proxyNode[t].proxy,e,r,...s),c={start:e,deleteCount:r,items:s};return n?delete this.dataNode[o].status:this.dataNode[o].status=a.active,L(this.dataNode,l.splice,c,i,this.proxyNode[t].target,this.metadata.trace),d},M=function(){if(this.dataNode[o].status!==a.active)return Array.prototype.shift.call(this.proxyNode[t].proxy);let e=!this.dataNode[o].hasOwnProperty("status");this.dataNode[o].status=a.splicing;let r=this.proxyNode[t].target.slice(0),s=Array.prototype.shift.call(this.proxyNode[t].proxy);return e?delete this.dataNode[o].status:this.dataNode[o].status=a.active,L(this.dataNode,l.shift,{},r,this.proxyNode[t].target,this.metadata.trace),s},W=function(...e){if(this.dataNode[o].status!==a.active)return Array.prototype.unshift.call(this.proxyNode[t].proxy,...e);let r=!this.dataNode[o].hasOwnProperty("status");this.dataNode[o].status=a.splicing;let s=this.proxyNode[t].target.slice(0),n=Array.prototype.unshift.call(this.proxyNode[t].proxy,...e),i={items:e};return r?delete this.dataNode[o].status:this.dataNode[o].status=a.active,L(this.dataNode,l.unshift,i,s,this.proxyNode[t].target,this.metadata.trace),n};let q=Object.keys(f);for(let e=q.length-1;e>=0;e--){let t=q[e],o="$"+t;f[o]=f[t],q.push(o)}class z{static make(e,r={}){const{strict:s=!0,methodsEmitRaw:i=!1,name:l="",debug:d}=r,c=d?.destroyDelay??1e3,p=d?.trace??"none";const u=E({[o]:{status:a.active,name:l},[t]:{isTreePrototype:!0}},"",{[o]:{status:n.alive},[t]:{isTreePrototype:!0}},e),f={strict:s,methodsEmitRaw:i,destroyDelay:c,trace:p,dataTree:u.dataNode,proxyTree:u.proxyNode};return z.createProxy(f,f.dataTree)}static createProxy(e,s,i){const l=s[t].proxyNode;let d,p;if(void 0===i)d=s,p=l;else{const e=E(s,i,l,l[t].target[i]);d=e.dataNode,p=e.proxyNode}const u=p[t].target,y=c(u);if(r[y]){const s=Proxy.revocable(u,{get:(r,a,s)=>!1===e.methodsEmitRaw&&Object.prototype.hasOwnProperty.call(_,a)&&a in Object.getPrototypeOf(r)?_[a].bind({metadata:e,dataNode:d,proxyNode:p}):q.includes(a)&&void 0===r[a]?f[a].bind({metadata:e,dataNode:d,proxyNode:p}):r.propertyIsEnumerable(a)&&"symbol"!=typeof a&&p[a]&&p[a][t].proxy&&p[a][o].status===n.alive?p[a][t].proxy:r[a],set:(s,i,l,u)=>{if(d[o].status===a.blocked)return console.error("object is blocked. can't change value of property:",i),!0;if("symbol"==typeof i||0===i.indexOf("_$"))return s[i]=l,!0;if("length"!==i&&!s.propertyIsEnumerable(i)){let e=Object.getOwnPropertyDescriptor(s,i);if("object"==typeof e&&!1===e.enumerable)return s[i]=l,!0}let f=s[i],y=!1;void 0!==p[i]&&void 0!==p[i][t].proxy&&(p[i][o].status=n.deleted,delete d[i][t].proxyNode,y=!0,e.strict&&setTimeout(z.destroy,e.destroyDelay,p[i][t].proxy)),l=$(l),s[i]=l;let h=!1,v=c(l);return r[v]&&(z.createProxy(e,d,i),h=!0),V(d,i,f,y,l,h,e.trace),!0},defineProperty:(a,s,i)=>{if("symbol"==typeof s)return Object.defineProperty(a,s,i),!0;let l=a[s],u=!1;void 0!==p[s]&&void 0!==p[s][t].proxy&&(p[s][o].status=n.deleted,delete d[s][t].proxyNode,u=!0,e.strict&&setTimeout(z.destroy,e.destroyDelay,p[s][t].proxy)),i.value=$(i.value),Object.defineProperty(a,s,i);let f=i.value,y=!1,h=c(i.value);return r[h]&&!0===i.enumerable&&(z.createProxy(e,d,s),y=!0),V(d,s,l,u,f,y,e.trace),!0},deleteProperty:(r,s)=>{if(!r.propertyIsEnumerable(s)||"symbol"==typeof s)return delete r[s],!0;if(d[o].status===a.blocked)return console.error(`can't delete property '${s}'. object is blocked.`),!0;if(s in r){let a=r[s],i=!1;return void 0!==p[s]&&void 0!==p[s][t].proxy&&(p[s][o].status=n.deleted,delete d[s][t].proxyNode,i=!0,e.strict&&setTimeout(z.destroy,e.destroyDelay,p[s][t].proxy)),delete r[s],V(d,s,a,i,void 0,!1,e.trace),!0}return!0}});if(p[t].proxy=s.proxy,p[t].revoke=s.revoke,r[y]){let t=Object.keys(u);for(let o of t){if(0===o.indexOf("_$"))continue;let t=c(u[o]);r[t]&&z.createProxy(e,d,o)}}else console.warn(`Type of "${y}" is not implemented`);return s.proxy}{const e=Object.keys(r);throw new Error(`Must observe an ${e.join("/")}`)}}static destroy(e){let a;try{a=e.$getProxserveNodes().proxyNode}catch(e){return}a[o].status===n.alive&&(a[o].status=n.deleted);let s=c(e);if(r[s]){let s=Object.keys(e);for(let o of s)if(0!==o.indexOf("_$"))try{let s=c(e[o]);r[s]&&z.destroy(a[o][t].proxy)}catch(e){console.error(e)}a[t].revoke?.(),a[o].status=n.revoked}else console.warn(`Type of "${s}" is not implemented`)}static splitPath(e){return p(e)}static evalPath(e,t){return u(e,t)}}export{z as Proxserve};
//# sourceMappingURL=index.min.js.map
